# GAS Misskey Bot (Gemini 2.5 Flash-Lite Edition)

Google Apps Script (GAS) と Google スプレッドシートだけで動作する、サーバーレスなMisskey Botです。
Googleの最新AIモデル「Gemini 2.5 Flash-Lite」を使用し、人間らしい会話やタイムラインの話題に合わせた投稿を行います。

## ✨ 特徴

* **完全サーバーレス**: GASの無料枠内で動作し、レンタルサーバーは不要です。
* **AI会話機能**: リプライ（メンション）に対し、キャラクター設定に基づいたAI応答を返します。
* **多彩な投稿モード**:
* ⏰ **スケジュール投稿**: 指定した時間帯にあいさつなどを投稿。
* 🎲 **ランダム投稿**: 登録した定型文をランダムに投稿。
* 🤖 **Gemini自動投稿**: TLの話題をAIが分析し、時事ネタやトレンドに触れた投稿を生成。
* 📊 **投票投稿**: 自動でアンケートを作成・投稿。


* **自動運用**:
* ❤ **自動リアクション**: TLの投稿にランダムでリアクション（条件指定可）。
* 🤝 **自動フォローバック**: フォローされたら自動でフォロバ。
* 🌙 **夜間停止モード**: 指定した時間は静かにします。


* **簡単管理**: ほぼ全ての設定やテキストデータをスプレッドシートで管理可能。

## 🛠 前提条件

1. **Googleアカウント** (無料版でOK)
2. **Misskeyアカウント** (Bot用のアカウント)
3. **Google AI Studio API Key** (Gemini利用のため / 無料で取得可能)

## 🚀 セットアップ手順

### 1. GASプロジェクトの作成

1. [Google Apps Script](https://script.google.com/) にアクセスし、「新しいプロジェクト」を作成します。
2. 以下のファイルを作成し、それぞれのコードを貼り付けます。
* `Config.gs`
* `Setup.gs`
* `MisskeyAPI.gs`
* `GeminiAPI.gs`
* `Features_Core.gs`
* `Webhook.gs`
* `MainDispatcher.gs`
* `Utils.gs`



### 2. 初期設定 (スプレッドシート作成)

1. GASエディタをリロード（F5）します。
2. メニューバーに **「Bot設定」** というメニューが表示されるのでクリックします。
3. **「1. 初期セットアップ (シート作成)」** を実行します。
* ※初回のみ権限承認のポップアップが出ます。「詳細」→「安全ではないページに移動」から許可してください。


4. 実行後、Googleドライブにスプレッドシートが生成され、必要なシート（設定、プロンプト、ログなど）が作られます。

### 3. APIキーとトークンの設定 (セキュリティ設定)

1. Misskeyで「設定」>「API」>「アクセストークンの発行」を行い、トークンを取得します（権限: ノートの作成、リアクション、フォロー、通知の閲覧など）。
2. [Google AI Studio](https://aistudio.google.com/) でAPIキーを取得します。
3. GASのメニューバー **「Bot設定」** > **「2. APIキー・トークン設定」** を実行します。
4. ダイアログに従い、`Misskey Token` と `Gemini API Key` を入力・保存します。
* ※これらはスプレッドシートには表示されず、GAS内部に安全に保存されます。



### 4. Webアプリとしてデプロイ (Webhook用)

Botがメンションやフォローに即座に反応するために必要です。

1. GAS画面右上の **「デプロイ」** > **「新しいデプロイ」** をクリック。
2. 「種類の選択」の歯車アイコン > **「ウェブアプリ」** を選択。
3. 以下の設定にします：
* **説明**: `v1` など（任意）
* **次のユーザーとして実行**: **自分**
* **アクセスできるユーザー**: **全員** (Misskeyサーバーからの通知を受け取るため必須)


4. 「デプロイ」をクリックし、発行された **ウェブアプリURL** をコピーします。

### 5. Misskey側でWebhook設定

1. Misskeyの「設定」>「Webhook」>「Webhookを作成」をクリック。
2. **名前**: 任意（例: GAS Bot）
3. **URL**: 手順4でコピーしたURLを貼り付け。
4. **シークレット**: 空欄でOK。
5. **イベント**: `フォロー (followed)` と `メンション (mention)` にチェックを入れる。
6. 「保存」をクリックし、Active（有効）になっていることを確認。

### 6. 定期実行トリガーの設定

Botが自発的に投稿（スケジュール投稿など）するために必要です。

1. GAS左メニューの時計アイコン（トリガー）をクリック。
2. 「トリガーを追加」をクリック。
3. 以下の設定で保存します：
* 実行する関数: `mainDispatcher`
* イベントのソース: **時間主導型**
* タイプ: **時間ベースのタイマー**
* 間隔: **1時間おき**



---

## 📝 運用・カスタマイズ

スプレッドシートの各シートを編集することで、Botの挙動を調整できます。

### 主要なシートの説明

| シート名 | 説明 |
| --- | --- |
| **設定** | Botの基本動作スイッチ、確率設定、各種制限などを管理します。 |
| **キャラクタープロンプト** | AI (Gemini) の性格設定。口調や一人称などを記述します。 |
| **スケジュール投稿** | 毎日決まった時間（7時、12時など）に投稿する候補文です。 |
| **ランダム投稿** | スケジュール以外の時間にランダムで投稿されるつぶやき候補です。 |
| **イベント** | 特定の日付（1/1など）に優先的に投稿される内容です。 |
| **ユーザー管理** | 会話したユーザーの履歴。好感度システム等に使用されます。 |
| **ダッシュボード** | 日々の投稿数やエラー発生状況を可視化します。 |

### Gemini AI投稿について

`ENABLE_GEMINI_POST` が `TRUE` の場合、指定間隔（デフォルト6時間）ごとに以下の動作をします。

1. タイムラインを取得し、現在のトレンドワードを抽出。
2. 「キャラクタープロンプト」の人格になりきって、その話題について投稿を作成。
3. Misskeyに投稿。

### 注意事項

* **自分のID設定**: `設定` シートの `OWN_USER_ID` にBot自身のユーザーIDを入力してください。これにより、自分の投稿に反応してしまうループを防げます。
* **Geminiの制限**: 無料版APIには制限があります。`GEMINI_DAILY_LIMIT` で1日の回数を制限しています。
* **コードの修正**: GASのコードを修正した際、Webhook機能（`doPost`）に関わる変更をした場合は、**「デプロイを管理」から「新しいバージョン」を作成してデプロイし直す**必要があります。

## ⚠️ トラブルシューティング

* **Q. メンションに反応しない**
* A. WebhookのURLが正しいか、デプロイ時に「アクセスできるユーザー：全員」になっているか確認してください。


* **Q. エラー通知が来る**
* A. `エラーログ` シートを確認してください。一時的な接続エラーの場合は無視して構いませんが、頻発する場合はAPIキーやトークンを再設定してください。


* **Q. AIが返信してくれない**
* A. 安全設定（Safety Settings）または1日の使用上限（Quota）に引っかかっている可能性があります。その場合、自動的に「フォールバック定型文」が使用されます。



## 📄 ライセンス

This project is licensed under the MIT License.