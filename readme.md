# GAS Misskey Bot (Gemini 2.5 Flash-Lite Edition)

Google Apps Script (GAS) と Google スプレッドシートだけで動く、あなただけのMisskey Botです。
Googleの最新AI「Gemini」を使って、人間みたいに会話したり、タイムラインの話題に合わせて自動で投稿したりします。

**レンタルサーバーは不要です。** 全部Googleのクラウド上で動きます！(無料枠内で動作)

## ✨ 何ができるの？

* ⏰ **スケジュール投稿**: 「おはよう」「おやすみ」など、決まった時間に投稿します。
* 🤖 **AI自動投稿**: タイムラインの話題をAIが読んで、流行りのネタでつぶやきます。
* 💬 **おしゃべり**: リプライ（メンション）を送ると、AIがキャラになりきって返信します。
* ❤ **キーワードリアクション**: 「おはよう」には🌅、「Misskey」には💙など、**特定の言葉に反応してリアクション**します。
* 🤝 **自動フォローバック**: フォローしてくれた人を自動でフォローし返します。
* 📊 **アンケート**: 「きのこたけのこどっち派？」みたいな投票を自動で作ります。

---

## 🛠 準備するもの

1. **Googleアカウント** (学校のアカウントではなく、個人のアカウント推奨)
2. **Google AI Studio API Key** (Geminiを使うための鍵 / 無料でとれます)
3. **Misskeyアカウント** (Botとして動かしたいアカウントを新しく用意して下さい)
* 利用規約を確認し、サーバー管理者さんに確認してからBotを設置してください。
* Misskey テスト環境 misskey 2025.12.1

---

## 🚀 セットアップ手順（ここからスタート！）

### 1. スプレッドシートとプログラムの準備

**この手順通りに作成することがとても重要です！**

1. パソコンでブラウザを開き、アドレスバーに `sheets.new` と入力してエンターキーを押します（新しいスプレッドシートが作られます）。
2. 左上のタイトル「無題のスプレッドシート」を「Misskey Bot 管理表」などに変更します。
3. メニューバーの **「拡張機能」** > **「Apps Script」** をクリックします。
4. 新しいタブでプログラムの編集画面が開きます。

### 2. コードのコピー＆ペースト

1. 開いた画面に、以下の8つのファイルを作成し、配布されたコードをそれぞれ貼り付けてください。
* `Config.gs`
* `Setup.gs`
* `MisskeyAPI.gs`
* `GeminiAPI.gs`
* `Features_Core.gs`
* `Webhook.gs`
* `MainDispatcher.gs`
* `Utils.gs`
* *(最初からある `コード.gs` は削除してOKです)*


2. すべて貼り付けたら、フロッピーディスクのアイコン（💾）を押して保存します。

### 3. 初期セットアップ (シートの作成)

1. Setup.gsを選択し、画面上のプルダウン（「デバッグ」の横）から **「setupSpreadsheet」** を選びます。
2. **「実行」** ボタンを押します。
3. **【重要】** 初回のみ「権限の承認」画面が出ます。
* 「権限を確認」をクリック
* 自分のGoogleアカウントを選択
* 「このアプリはGoogleによって確認されていません」と出たら、左下の **「詳細」** を押し、さらに下に出る **「(安全ではないページ)に移動」** をクリックします。
* **「許可」** をクリックします。


4. 下のログ画面に「完了」と出れば成功です！

### 4. APIキーとトークンの設定 (セキュリティ設定)

1. **スプレッドシートの画面に戻り、ページを再読み込み（F5キー）** します。
2. 数秒待つと、メニューの右端（ヘルプの隣）に **「Bot設定」** という新しいメニューが出ます。
3. **「Bot設定」** > **「2. APIキー・トークン設定」** をクリックします。
4. 画面の指示に従って、以下の2つを入力します。
* **Misskey Token**: Misskeyの「設定」>「API」>「アクセストークンの発行」で取得したもの。
* **Gemini API Key**: [Google AI Studio](https://aistudio.google.com/) で取得したもの。



### 5. Bot自身のID設定 (無限ループ防止)

Botが自分の投稿に反応して暴走しないように、Bot自身のIDを登録します。

1. MisskeyでBotのアカウントにログインし、プロフィールページを開きます。
2. URLを確認します。 `https://misskey.example.net/@User_Name` のようになっている場合、設定メニューからIDを探す必要があります。
* 一番確実な方法：Misskeyの「設定」>「API」>「コンソール」を開き、API名に `i` と入力して「Send」を押すと、あなたの情報が表示されます。そこにある `"id": "xxxxxxxxxx"` の `xxxxxxxxxx` の部分をコピーしてください。

3. スプレッドシートの **「設定」** シートを開きます。
4. 一番下の `OWN_USER_ID` という行のB列に、コピーしたIDを貼り付けます。

### 6. Webアプリとしてデプロイ (Webhook用)

Botが「メンション」や「フォロー」にすぐ反応できるように設定します。

1. プログラム画面（Apps Script）に戻り、右上の **「デプロイ」** > **「新しいデプロイ」** をクリック。
2. 「種類の選択」の歯車アイコン > **「ウェブアプリ」** を選択。
3. 以下のように設定します（ここを間違えると動きません！）：
* **説明**: `v1` （なんでもOK）
* **次のユーザーとして実行**: **自分**
* **アクセスできるユーザー**: **全員**


4. 「デプロイ」をクリックし、表示された **ウェブアプリURL** をコピーします。

### 7. Misskey側でWebhook設定

1. Misskeyの「設定」>「Webhook」>「Webhookを作成」をクリック。
2. **名前**: `GAS Bot` など
3. **URL**: さっきコピーしたURLを貼り付け。
4. **イベント**: `フォロー (followed)` と `メンション (mention)` にチェック。
5. 「保存」をクリックし、Active（有効）になっていることを確認。

### 8. 定期実行タイマーの設定

Botが自動で投稿するようにタイマーをセットします。

1. Apps Script画面の左メニューにある時計アイコン（トリガー）をクリック。
2. 「トリガーを追加」をクリック。
3. 以下のように設定して保存します：
* 実行する関数: `mainDispatcher`
* イベントのソース: **時間主導型**
* タイプ: **時間ベースのタイマー**
* 間隔: **1時間おき**



---

## 📖 運用ガイド

### 🔰 最初にやること（動作テスト）

初期設定では、Botの投稿範囲は **「ホーム（home）」** になっています。
まずはBotが動いているか確認しましょう。

1. 1時間待つか、MainDispatcher.gsを選択し`mainDispatcher` 関数を手動で実行してみます。
2. Misskeyのホームタイムラインに投稿されれば成功です！
3. 動作に問題がなければ、スプレッドシートの「設定」シートにある **`POST_VISIBILITY`** を `home` から `public` に書き換えてください。これで誰からでも見えるようになります。

### 📝 シートの書き方（カスタマイズ）

| シート名 | 説明・書き方 |
| --- | --- |
| **設定** | Botの動きを設定します。 |
| **キャラクタープロンプト** | AIの性格を書きます。「〜だよ」のような口調を指定すると上手く喋ります。 |
| **リアクション** | **A列に「反応したい言葉」、B列以降に「絵文字」**を書きます。<br>

<br>例：A列「おはよう」 B列「🌅」 C列「🐔」 |
| **スケジュール投稿** | 毎日決まった時間に投稿する内容です。 |
| **ランダム投稿** | スケジュール以外の時間にランダムにつぶやく内容です。 |

### ⚙️ 設定を変更したとき

スプレッドシートの「設定」や「投稿内容」を書き換えた場合：

* **反映のタイミング**: Botは読み込みを早くするために、設定を5分間保存（キャッシュ）します。**書き換えてから反映されるまで、最大5分ほどかかります。** すぐに反映されなくても焦らず待ちましょう。
* **GASの操作**: スプレッドシートを書き換えるだけなら、プログラムを触る必要はありません。

### 💾 プログラム（コード）を変更したとき

「返信の言葉を変えたい」などでプログラムコード自体を修正した場合：

1. **保存**: 変更したら必ず「保存（💾）」を押してください。
* スケジュール投稿などの「タイマーで動く機能」は、保存するだけで新しいコードで動きます。


2. **再デプロイ（重要！）**: リプライ返信などの「Webhookで動く機能」を変更した場合は、**デプロイし直さないと反映されません。**
* 右上の「デプロイ」 > **「デプロイを管理」** をクリック。
* 右上の鉛筆アイコン（編集）をクリック。
* 「バージョン」を **「新しいバージョン」** に変更。
* 「デプロイ」をクリック。
* ※URLは変わらないので、Misskey側の設定はそのままで大丈夫です。



---

## ⚠️ 困ったときは？

* **Q. 返信してくれない！**
* A. `OWN_USER_ID` は設定しましたか？ 自分の投稿には反応しません。また、デプロイ時に「アクセスできるユーザー：全員」にしましたか？


* **Q. エラー通知メールが届く**
* A. 一時的な不具合なら無視して大丈夫です。ずっと届く場合は、「Bot設定」>「APIキー設定」をやり直してみてください。


* **Q. Botが静かになった**
* A. 夜間モード（23時〜6時）になっていませんか？ スプレッドシートの `NIGHT_START` で時間を変えられます。



---

## 📄 ライセンス

このプログラムは MIT License です。自由に改造して使ってね！